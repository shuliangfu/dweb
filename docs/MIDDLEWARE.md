# DWeb 中间件文档

## 现有中间件分析

### ✅ 已实现的中间件

#### 1. **logger** - 日志记录中间件
**功能**：
- 记录 HTTP 请求日志
- 支持多种日志格式（combined, common, dev, short, tiny）
- 可配置跳过特定请求

**使用场景**：
- 开发环境调试
- 生产环境请求追踪
- API 访问日志

**推荐指数**：⭐⭐⭐⭐⭐（必备）

---

#### 2. **cors** - 跨域资源共享中间件
**功能**：
- 处理跨域请求
- 支持自定义允许的源、方法、头部
- 预检请求处理

**使用场景**：
- API 服务需要跨域访问
- 前后端分离架构
- 移动端应用

**推荐指数**：⭐⭐⭐⭐⭐（API 必备）

---

#### 3. **body-parser** - 请求体解析中间件
**功能**：
- 解析 JSON、URL-encoded、文本、原始数据
- 支持文件上传（multipart/form-data）
- 可配置大小限制

**使用场景**：
- RESTful API
- 表单提交
- 文件上传

**推荐指数**：⭐⭐⭐⭐⭐（必备）

---

#### 4. **static** - 静态文件服务中间件
**功能**：
- 提供静态文件服务
- 支持目录映射
- 自动设置 Content-Type
- 支持缓存控制

**使用场景**：
- 提供 CSS、JS、图片等静态资源
- 单页应用（SPA）部署
- 资源文件服务

**推荐指数**：⭐⭐⭐⭐（常用）

---

#### 5. **compression** - 压缩中间件
**功能**：
- Gzip/Brotli 压缩响应
- 可配置压缩级别和阈值
- 自动检测客户端支持

**使用场景**：
- 减少传输数据量
- 提升页面加载速度
- API 响应优化

**推荐指数**：⭐⭐⭐⭐⭐（性能优化必备）

---

#### 6. **security** - 安全中间件
**功能**：
- 设置安全 HTTP 头部
- XSS 防护
- CSRF 防护
- CSP（内容安全策略）
- HSTS（严格传输安全）

**使用场景**：
- 生产环境安全加固
- 防止常见 Web 攻击
- 合规性要求

**推荐指数**：⭐⭐⭐⭐⭐（安全必备）

---

#### 7. **health** - 健康检查中间件
**功能**：
- 提供健康检查端点
- 支持就绪性检查（readiness）
- 支持存活检查（liveness）
- 自定义健康检查逻辑

**使用场景**：
- Kubernetes/Docker 健康检查
- 负载均衡器健康检查
- 监控系统集成

**推荐指数**：⭐⭐⭐⭐（生产环境推荐）

---

#### 8. **rate-limit** - 速率限制中间件
**功能**：
- 限制请求频率
- 支持内存和 Redis 存储
- 可配置窗口大小和最大请求数
- 自定义限流策略

**使用场景**：
- 防止 API 滥用
- DDoS 防护
- 资源保护

**推荐指数**：⭐⭐⭐⭐⭐（API 安全必备）

---

#### 9. **auth** - JWT 认证中间件
**功能**：
- JWT Token 验证
- 支持 Header 和 Cookie 方式
- 可配置跳过路径
- 自定义验证逻辑

**使用场景**：
- API 身份验证
- 用户登录验证
- 权限控制

**推荐指数**：⭐⭐⭐⭐⭐（认证必备）

---

## 推荐的新中间件

### 🔥 高优先级推荐

#### 1. **request-id** - 请求 ID 中间件
**功能**：
- 为每个请求生成唯一 ID
- 在响应头中返回请求 ID
- 支持自定义 ID 生成器
- 便于日志追踪和问题排查

**使用场景**：
- 分布式系统请求追踪
- 日志关联分析
- 问题排查和调试

**推荐指数**：⭐⭐⭐⭐⭐

**实现难度**：低

---

#### 2. **timeout** - 请求超时中间件
**功能**：
- 设置请求处理超时时间
- 自动取消超时请求
- 返回超时错误响应
- 可配置不同路径的超时时间

**使用场景**：
- 防止长时间运行的请求阻塞
- API 响应时间控制
- 资源保护

**推荐指数**：⭐⭐⭐⭐

**实现难度**：中

---

#### 3. **helmet** - 安全头部增强中间件
**功能**：
- 增强安全头部设置
- 更细粒度的 CSP 配置
- 自动移除不安全的头部
- 支持多种安全策略

**使用场景**：
- 增强现有 security 中间件
- 更严格的安全策略
- 合规性要求

**推荐指数**：⭐⭐⭐⭐

**实现难度**：中（可与 security 合并）

---

#### 4. **request-validator** - 请求验证中间件
**功能**：
- 验证请求参数、查询参数、请求体
- 支持 JSON Schema 验证
- 自动返回验证错误
- 类型安全的验证

**使用场景**：
- API 参数验证
- 数据格式校验
- 减少业务代码中的验证逻辑

**推荐指数**：⭐⭐⭐⭐⭐

**实现难度**：中

---

#### 5. **response-time** - 响应时间中间件
**功能**：
- 记录请求处理时间
- 在响应头中返回处理时间
- 支持性能监控集成

**使用场景**：
- 性能监控
- API 性能分析
- 慢请求识别

**推荐指数**：⭐⭐⭐⭐

**实现难度**：低

---

### 📦 中优先级推荐

#### 6. **session** - 会话管理中间件
**功能**：
- 服务器端会话管理
- 支持内存、Redis、数据库存储
- 自动生成会话 ID
- 会话过期管理

**使用场景**：
- 传统 Web 应用
- 需要服务器端会话的场景
- 与 JWT 互补

**推荐指数**：⭐⭐⭐⭐

**实现难度**：中

---

#### 7. **cache-control** - 缓存控制中间件
**功能**：
- 自动设置 Cache-Control 头部
- 支持不同路径的缓存策略
- ETag 支持
- Last-Modified 支持

**使用场景**：
- 静态资源缓存
- API 响应缓存
- CDN 集成

**推荐指数**：⭐⭐⭐⭐

**实现难度**：中

---

#### 8. **ip-filter** - IP 过滤中间件
**功能**：
- IP 白名单/黑名单
- 支持 CIDR 格式
- 地理位置过滤（需要 GeoIP 库）
- 自动阻止恶意 IP

**使用场景**：
- 限制访问来源
- 防止恶意请求
- 地理位置限制

**推荐指数**：⭐⭐⭐

**实现难度**：低

---

#### 9. **request-size-limit** - 请求大小限制中间件
**功能**：
- 限制请求体大小
- 限制 URL 长度
- 限制查询参数数量
- 自动拒绝超大请求

**使用场景**：
- 防止 DoS 攻击
- 资源保护
- 与 body-parser 配合使用

**推荐指数**：⭐⭐⭐⭐

**实现难度**：低

---

#### 10. **error-handler** - 统一错误处理中间件
**功能**：
- 统一错误响应格式
- 自动记录错误日志
- 支持自定义错误处理
- 开发环境详细错误信息

**使用场景**：
- 统一错误处理
- 错误日志记录
- 用户体验优化

**推荐指数**：⭐⭐⭐⭐⭐

**实现难度**：中

---

### 🎯 特殊场景推荐

#### 11. **websocket-auth** - WebSocket 认证中间件
**功能**：
- WebSocket 连接认证
- Token 验证
- 连接权限控制

**使用场景**：
- WebSocket 服务
- 实时通信应用
- 需要认证的 WebSocket

**推荐指数**：⭐⭐⭐（特定场景）

**实现难度**：中

---

#### 12. **graphql** - GraphQL 中间件
**功能**：
- GraphQL 请求处理
- 查询验证
- 错误格式化

**使用场景**：
- GraphQL API
- 与 REST API 共存

**推荐指数**：⭐⭐⭐（特定场景）

**实现难度**：高（需要 GraphQL 库）

---

#### 13. **metrics** - 指标收集中间件
**功能**：
- 收集请求指标（QPS、延迟、错误率）
- 支持 Prometheus 格式
- 自定义指标收集

**使用场景**：
- 监控系统集成
- 性能分析
- 告警系统

**推荐指数**：⭐⭐⭐⭐（生产环境）

**实现难度**：中

---

#### 14. **tracing** - 分布式追踪中间件
**功能**：
- OpenTelemetry 集成
- 请求追踪
- 跨服务追踪

**使用场景**：
- 微服务架构
- 分布式系统
- 性能分析

**推荐指数**：⭐⭐⭐（特定场景）

**实现难度**：高

---

#### 15. **multipart** - 多部分请求处理中间件
**功能**：
- 增强的 multipart/form-data 处理
- 文件流式处理
- 大文件上传支持

**使用场景**：
- 大文件上传
- 流式文件处理
- 与 body-parser 互补

**推荐指数**：⭐⭐⭐（特定场景）

**实现难度**：中

---

## 中间件使用建议

### 开发环境推荐配置
```typescript
import { logger, cors, bodyParser, compression } from "@dreamer/dweb";

export default {
  middleware: [
    logger({ format: 'dev' }),
    cors({ origin: '*' }),
    bodyParser(),
    compression(),
  ],
};
```

### 生产环境推荐配置
```typescript
import {
  logger,
  cors,
  bodyParser,
  compression,
  security,
  rateLimit,
  health,
  requestId, // 推荐添加
  errorHandler, // 推荐添加
} from "@dreamer/dweb";

export default {
  middleware: [
    requestId(), // 请求追踪
    logger({ format: 'combined' }),
    cors({ origin: ['https://example.com'] }),
    security({
      csrfProtection: true,
      hsts: true,
    }),
    rateLimit({
      windowMs: 15 * 60 * 1000, // 15分钟
      max: 100, // 最多100个请求
    }),
    compression(),
    bodyParser({ limit: '10mb' }),
    health(),
    errorHandler(), // 统一错误处理
  ],
};
```

### API 服务推荐配置
```typescript
import {
  logger,
  cors,
  bodyParser,
  compression,
  auth,
  rateLimit,
  requestValidator, // 推荐添加
  responseTime, // 推荐添加
} from "@dreamer/dweb";

export default {
  middleware: [
    requestId(),
    logger(),
    cors({ origin: '*' }),
    responseTime(), // 性能监控
    rateLimit({ max: 1000, windowMs: 60000 }),
    compression(),
    bodyParser(),
    requestValidator(), // 参数验证
    auth({ secret: process.env.JWT_SECRET }),
  ],
};
```

## 总结

### 现有中间件覆盖度：⭐⭐⭐⭐⭐
已实现的 9 个中间件覆盖了大部分常用场景，包括：
- ✅ 日志记录
- ✅ 跨域处理
- ✅ 请求解析
- ✅ 静态文件
- ✅ 压缩优化
- ✅ 安全防护
- ✅ 健康检查
- ✅ 速率限制
- ✅ 身份认证

### 推荐优先实现
1. **request-id** - 请求追踪（高优先级）
2. **error-handler** - 统一错误处理（高优先级）
3. **request-validator** - 请求验证（高优先级）
4. **response-time** - 响应时间（中优先级）
5. **timeout** - 请求超时（中优先级）

这些中间件可以显著提升框架的可用性、可维护性和安全性。

