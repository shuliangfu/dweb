### i18n - 国际化

i18n 插件提供多语言支持，支持自动语言检测、翻译文件管理和全局翻译函数。

#### 架构与特性

*   **混合加载策略 (Hybrid Loading)**：
    支持从构建目录（生产环境）或源码目录（开发环境）灵活加载翻译文件。同时提供了 API 端点 (`/i18n/locales/:lang.json`)，允许客户端按需获取翻译包，减少首屏体积。

*   **多维语言检测**：
    实现了基于 `路径` -> `查询参数` -> `Cookie` -> `Header` 的多级语言检测策略，确保用户始终能获得正确的语言体验。

*   **全局注入**：
    在服务端和客户端均注入全局 `$t` 函数，保证同构代码的一致性，使得在组件中进行国际化变得异常简单。

#### 基本配置

```typescript
import { i18n } from "@dreamer/dweb/plugins";

app.plugin(
  i18n({
    languages: [ // 支持的语言列表（必需）
      { 
        code: "en-US", // 语言代码（如 'en', 'zh-CN'）
        name: "English", // 语言名称（可选）
        file: "en-US.json", // 语言文件路径（可选）
        default: true, // 是否为默认语言（可选）
        rtl: false, // 是否为 RTL 语言（可选）
      },
      { code: "zh-CN", name: "中文" },
    ],
    translationsDir: "locales", // 翻译文件目录（可选，默认为 'locales'）
    defaultLanguage: "en-US", // 默认语言代码（可选，如果不指定，使用 languages 中标记为 default 的语言）
    detection: { // 语言检测方式（可选）
      fromPath: true, // 是否从 URL 路径检测（如 /en/page），默认 true
      fromQuery: true, // 是否从查询参数检测（如 ?lang=en），默认 true
      fromCookie: true, // 是否从 Cookie 检测，默认 true
      cookieName: "lang", // Cookie 名称（默认为 'lang'）
      fromHeader: true, // 是否从 Accept-Language 头检测，默认 true
    },
    routePrefix: undefined, // 路由前缀（如 '/:lang/'），可选
    injectLangAttribute: true, // 是否在 HTML 中注入语言属性（默认为 true）
    dateFormat: { // 日期格式化选项（可选）
      format: "medium", // 日期格式（'short' | 'medium' | 'long' | 'full' | string）
      timeZone: "Asia/Shanghai", // 时区
    },
    numberFormat: { // 数字格式化选项（可选）
      style: "decimal", // 样式（'decimal' | 'currency' | 'percent'）
      currency: "USD", // 货币代码
      minimumFractionDigits: 0, // 最小小数位数
      maximumFractionDigits: 2, // 最大小数位数
    },
  }),
);
```

#### 配置选项

**必需参数：**

- `languages` - 支持的语言列表，每个语言对象包含：
  - `code` - 语言代码（如 'en', 'zh-CN'）
  - `name` - 语言名称（可选）
  - `file` - 语言文件路径（可选）
  - `default` - 是否为默认语言（可选）
  - `rtl` - 是否为 RTL 语言（可选）

**可选参数：**

- `translationsDir` - 翻译文件目录（默认为 'locales'）
- `defaultLanguage` - 默认语言代码（如果不指定，使用 languages 中标记为 default 的语言）
- `detection` - 语言检测方式配置对象：
  - `fromPath` - 是否从 URL 路径检测（如 /en/page），默认 true
  - `fromQuery` - 是否从查询参数检测（如 ?lang=en），默认 true
  - `fromCookie` - 是否从 Cookie 检测，默认 true
  - `cookieName` - Cookie 名称（默认为 'lang'）
  - `fromHeader` - 是否从 Accept-Language 头检测，默认 true
- `routePrefix` - 路由前缀（如 '/:lang/'），可选
- `injectLangAttribute` - 是否在 HTML 中注入语言属性（默认为 true）
- `dateFormat` - 日期格式化选项：
  - `format` - 日期格式（'short' | 'medium' | 'long' | 'full' | string）
  - `timeZone` - 时区
- `numberFormat` - 数字格式化选项：
  - `style` - 样式（'decimal' | 'currency' | 'percent'）
  - `currency` - 货币代码
  - `minimumFractionDigits` - 最小小数位数
  - `maximumFractionDigits` - 最大小数位数

#### 翻译文件结构

翻译文件应放在 `translationsDir` 目录下，文件名格式为 `{语言代码}.json`：

```json
// locales/en-US.json
{
  "common": {
    "welcome": "Hello, World!",
    "greeting": "Hello, {name}!"
  },
  "validation": {
    "required": "{field} is required"
  }
}
```

```json
// locales/zh-CN.json
{
  "common": {
    "welcome": "你好，世界！",
    "greeting": "你好，{name}！"
  },
  "validation": {
    "required": "{field} 是必填字段"
  }
}
```

#### 使用翻译函数

**方式 1：全局 `$t()` 函数（推荐）**

无需导入，全局可用：

```typescript
// 在任何地方直接使用
console.log($t("common.welcome"));
const message = $t("common.greeting", { name: "John" });
```

**方式 2：通过 `LoadContext` 或 `PageProps`**

```typescript
// routes/index.tsx
export async function load({ t }: LoadContext) {
  const message = t("common.welcome");
  return { message };
}

export default function HomePage({ t }: PageProps) {
  return <div>{t("common.welcome")}</div>;
}
```

**方式 3：使用 `getI18n()` 函数（服务端）**

```typescript
import { getI18n } from "@dreamer/dweb/plugins";

const t = getI18n();
const message = t("common.welcome");
```

**方式 4：使用客户端 API（客户端组件）**

```typescript
import { 
  getCurrentLanguage, 
  setCurrentLanguage, 
  translate,
  getI18n 
} from "@dreamer/dweb/client";

// 获取当前语言
const currentLang = getCurrentLanguage(); // 'zh-CN'

// 设置语言（会重新加载语言包）
await setCurrentLanguage('en-US');

// 翻译文本
const text = translate('common.welcome', { name: 'John' });

// 获取 i18n 数据对象
const i18nData = getI18n();
```

#### 语言检测优先级

1. URL 路径（如 `/en/page`）- 需要启用 `fromPath: true`
2. 查询参数（如 `?lang=en`）- 需要启用 `fromQuery: true`
3. Cookie - 需要启用 `fromCookie: true`
4. Accept-Language 头 - 需要启用 `fromHeader: true`
5. 默认语言（配置中的 `defaultLanguage`）

#### 客户端 API

在客户端组件中，可以使用以下 API 来操作 i18n：

- **`getCurrentLanguage()`** - 获取当前语言代码
- **`setCurrentLanguage(langCode: string)`** - 设置当前语言（会重新加载语言包并更新 Cookie）
- **`translate(key: string, params?: Record<string, any>)`** - 翻译函数
- **`getI18n()`** - 获取 i18n 数据对象（包含 `lang`、`translations`、`t` 函数）
- **`getTranslations()`** - 获取当前语言的翻译数据对象
- **`isI18nInitialized()`** - 检查 i18n 是否已初始化

```typescript
import { 
  getCurrentLanguage, 
  setCurrentLanguage, 
  translate 
} from "@dreamer/dweb/client";

// 在客户端组件中使用
export default function LanguageSwitcher() {
  const currentLang = getCurrentLanguage();
  
  const handleLanguageChange = async (lang: string) => {
    await setCurrentLanguage(lang);
    // 语言切换后，页面会自动更新
  };
  
  return (
    <div>
      <p>{translate('common.currentLanguage')}: {currentLang}</p>
      <button onClick={() => handleLanguageChange('zh-CN')}>
        切换到中文
      </button>
      <button onClick={() => handleLanguageChange('en-US')}>
        Switch to English
      </button>
    </div>
  );
}
```

#### 更多信息

详细使用说明请参考 [i18n 使用文档](./i18n-usage.md)。
